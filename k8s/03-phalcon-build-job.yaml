apiVersion: v1
kind: ConfigMap
metadata:
  name: phalcon-dockerfile
  namespace: tahmin1x2
data:
  Dockerfile: |
    FROM php:8.2-fpm-alpine AS base
    RUN apk add --no-cache \
        postgresql-dev \
        libpq \
        autoconf \
        g++ \
        make \
        nginx \
        supervisor \
        git \
        unzip \
        libzip-dev \
        oniguruma-dev \
        libpng-dev \
        libjpeg-turbo-dev \
        freetype-dev
    RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
        && docker-php-ext-install -j$(nproc) \
            pdo \
            pdo_pgsql \
            pgsql \
            mbstring \
            zip \
            gd \
            opcache
    RUN pecl install redis \
        && docker-php-ext-enable redis
    RUN pecl channel-update pecl.php.net \
        && pecl install phalcon-5.8.0 \
        && docker-php-ext-enable phalcon
    COPY --from=composer:2 /usr/bin/composer /usr/bin/composer
    RUN echo "pm = dynamic" >> /usr/local/etc/php-fpm.d/www.conf \
        && echo "pm.max_children = 50" >> /usr/local/etc/php-fpm.d/www.conf \
        && echo "pm.start_servers = 10" >> /usr/local/etc/php-fpm.d/www.conf \
        && echo "pm.min_spare_servers = 5" >> /usr/local/etc/php-fpm.d/www.conf \
        && echo "pm.max_spare_servers = 20" >> /usr/local/etc/php-fpm.d/www.conf \
        && echo "pm.max_requests = 500" >> /usr/local/etc/php-fpm.d/www.conf
    RUN echo "opcache.enable=1" >> /usr/local/etc/php/conf.d/opcache.ini \
        && echo "opcache.memory_consumption=256" >> /usr/local/etc/php/conf.d/opcache.ini \
        && echo "opcache.max_accelerated_files=20000" >> /usr/local/etc/php/conf.d/opcache.ini \
        && echo "opcache.validate_timestamps=0" >> /usr/local/etc/php/conf.d/opcache.ini \
        && echo "realpath_cache_size=4096K" >> /usr/local/etc/php/conf.d/opcache.ini \
        && echo "realpath_cache_ttl=600" >> /usr/local/etc/php/conf.d/opcache.ini
    WORKDIR /app
    FROM base AS builder
    COPY composer.json composer.lock /app/
    RUN composer install --no-dev --no-scripts --no-autoloader --prefer-dist
    COPY . /app
    RUN composer dump-autoload --optimize --classmap-authoritative
    FROM base AS final
    COPY --from=builder /app /app
    RUN mkdir -p /app/storage/logs /app/storage/cache \
        && chmod -R 777 /app/storage
    COPY docker/nginx.conf /etc/nginx/nginx.conf
    COPY docker/default.conf /etc/nginx/http.d/default.conf
    COPY docker/supervisord.conf /etc/supervisord.conf
    RUN addgroup -g 1001 nginx-app \
        && adduser -D -u 1001 -G nginx-app nginx-app \
        && chown -R nginx-app:nginx-app /app /var/lib/nginx /var/log/nginx
    EXPOSE 8000
    HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
        CMD wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1
    CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]
---
apiVersion: v1
kind: Pod
metadata:
  name: kaniko-phalcon-backend
  namespace: tahmin1x2
spec:
  restartPolicy: Never
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    args:
    - "--dockerfile=/workspace/Dockerfile"
    - "--context=/workspace"
    - "--destination=registry.tahmin1x2.svc.cluster.local:5000/phalcon-backend:v1"
    - "--insecure"
    - "--skip-tls-verify"
    - "--cache=false"
    volumeMounts:
    - name: dockerfile
      mountPath: /workspace/Dockerfile
      subPath: Dockerfile
    - name: code
      mountPath: /workspace
  volumes:
  - name: dockerfile
    configMap:
      name: phalcon-dockerfile
  - name: code
    persistentVolumeClaim:
      claimName: code-pvc
